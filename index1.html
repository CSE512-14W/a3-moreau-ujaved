
<!DOCTYPE html>
<meta charset="utf-8">
<title>Streamgraph</title>
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  position: relative;
  width: 960px;
}

button {
  position: absolute;
  right: 10px;
  top: 10px;
}

</style>
<button onclick="transition()">Update</button>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

function parseDate(d) {
  var parser = d3.time.format("%d-%b-%y").parse;
  if (parser(d) == null) {
    parser = d3.time.format("%B, %Y").parse;
  }
  if (parser(d) == null) {
    parser = d3.time.format("%Y").parse;
  }
  return parser(d);
};

function isValidDate(d) {
  //d is in Date format
  var maxDate = d3.time.format("%Y-%m-%d").parse("2014-01-01");
  var minDate = d3.time.format("%Y-%m-%d").parse("1980-01-01");
  if ((d==null) || ((+d) > (+maxDate)) || ((+d) < (+minDate))) {
    return false;
  }
  return true;
}

function isValidGenre(g) {
  if (g==null || g.length===0) {
    return false;
  }
  return true;
}

function getLayer(movies,dates) {
  return dates.map(function(d){
    var count = 0;
    for (var i = 0; i < movies.length; i++) {
      if (movies[i].year==d)
        count += 1
  }
  return {x: d, y: count};
  });
}

var width = 960,
    height = 500;


var dataset;
var stack;
d3.csv("movies.csv", function(error, data) {
    dataset = [];
    var genres = new Object();
    var dates = new Object();
    var genre2movies = new Object();
    data.forEach(function(d) {
      var date = parseDate(d['Release Date']);
      if (isValidDate(date) && isValidGenre(d['Major Genre'])) {
        var y = +date.getFullYear();
        genre = d['Major Genre']; 
        genres[genre] = true;
        dates[y] = true;

        d.year = y;
        dataset.push(d);

        if (genre in genre2movies){
          genre2movies[genre].push(d);
        } else {
          genre2movies[genre] = [];
        }
      }
    });
    dates = d3.keys(dates);
    genres = d3.keys(genres);
    //var numLayers = Object.getOwnPropertyNames(genres).length;
    stack = d3.layout.stack().offset("wiggle");
    var stack2DArray = genres.map(function(g) { return getLayer(genre2movies[g],dates); });
    var layers = stack(stack2DArray);

    //console.log(d3.max(dataset, function(d) { return d.date; }));
    //console.log(d3.min(dataset, function(d) { return d.date; }));

    var x = d3.time.scale()
            .domain(d3.extent(dates))
            .range([0, width]);

    var y = d3.scale.linear()
            .domain([0, d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); })])
            .range([height, 0]);

    var color = d3.scale.linear()
                .range(["#aad", "#556"]);

    var area = d3.svg.area()
               .x(function(d) { return x(d.x); })
               .y0(function(d) { return y(d.y0); })
               .y1(function(d) { return y(d.y0 + d.y); });

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

    svg.selectAll("path")
    .data(layers)
  .enter().append("path")
    .attr("d", area)
    .style("fill", function() { return color(Math.random()); });
});


</script>